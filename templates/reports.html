{% extends "base.html" %}

{% block title %}æŠ¥è¡¨ç»Ÿè®¡ - è‚¡ç¥¨äº¤æ˜“è®°å½•ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“Š æŠ¥è¡¨ç»Ÿè®¡</h1>
</div>

<!-- æŠ¥è¡¨ç±»å‹é€‰æ‹© -->
<div class="report-tabs">
    <a href="{{ url_for('reports', type='daily', year=current_year, month=current_month, day=current_day) }}"
       class="tab {{ 'active' if report_type == 'daily' else '' }}">
        æ—¥æŠ¥è¡¨
    </a>
    <a href="{{ url_for('reports', type='monthly', year=current_year, month=current_month) }}"
       class="tab {{ 'active' if report_type == 'monthly' else '' }}">
        æœˆæŠ¥è¡¨
    </a>
    <a href="{{ url_for('reports', type='yearly', year=current_year) }}"
       class="tab {{ 'active' if report_type == 'yearly' else '' }}">
        å¹´æŠ¥è¡¨
    </a>
</div>

<!-- æ—¥æœŸé€‰æ‹©å™¨ -->
<div class="report-filters">
    {% if report_type == 'daily' %}
        <form method="GET" action="{{ url_for('reports') }}" class="filter-form">
            <input type="hidden" name="type" value="daily">
            <div class="filter-group">
                <label>é€‰æ‹©æ—¥æœŸï¼š</label>
                <input type="date" name="date"
                       value="{{ report_data.date.strftime('%Y-%m-%d') }}"
                       onchange="this.form.submit()">
            </div>
        </form>
    {% elif report_type == 'monthly' %}
        <form method="GET" action="{{ url_for('reports') }}" class="filter-form">
            <input type="hidden" name="type" value="monthly">
            <div class="filter-group">
                <label>é€‰æ‹©æœˆä»½ï¼š</label>
                <input type="month" name="month"
                       value="{{ '%04d-%02d'|format(current_year, current_month) }}"
                       onchange="this.form.submit()">
            </div>
        </form>
    {% else %}
        <form method="GET" action="{{ url_for('reports') }}" class="filter-form">
            <input type="hidden" name="type" value="yearly">
            <div class="filter-group">
                <label>é€‰æ‹©å¹´ä»½ï¼š</label>
                <select name="year" onchange="this.form.submit()">
                    {% for y in range(2020, 2030) %}
                        <option value="{{ y }}" {{ 'selected' if y == current_year else '' }}>{{ y }}å¹´</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    {% endif %}
</div>

<!-- æŠ¥è¡¨å†…å®¹ -->
<div class="report-content">
    {% if report_type == 'daily' %}
        <!-- æ—¥æŠ¥è¡¨ -->
        <div class="report-summary">
            <h2>ğŸ“… {{ report_data.date.strftime('%Yå¹´%mæœˆ%dæ—¥') }} äº¤æ˜“æ±‡æ€»</h2>
            <div class="stats-grid stats-grid-4">
                <div class="stat-card">
                    <div class="stat-value">{{ report_data.total_trades }}</div>
                    <div class="stat-label">äº¤æ˜“ç¬”æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ report_data.buy_count }}</div>
                    <div class="stat-label">ä¹°å…¥ç¬”æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ report_data.sell_count }}</div>
                    <div class="stat-label">å–å‡ºç¬”æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value {{ 'positive' if report_data.net_amount > 0 else 'negative' }}">
                        Â¥{{ "%.2f"|format(report_data.net_amount) }}
                    </div>
                    <div class="stat-label">å‡€é‡‘é¢ (å–å‡º - ä¹°å…¥)</div>
                </div>
            </div>
        </div>

        <div class="report-detail">
            <h3>ğŸ“‹ äº¤æ˜“æ˜ç»†</h3>
            {% if trades %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>è‚¡ç¥¨åç§°</th>
                            <th>ç±»å‹</th>
                            <th>æ•°é‡</th>
                            <th>ä»·æ ¼</th>
                            <th>é‡‘é¢</th>
                            <th>æƒ³æ³•</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in trades %}
                        <tr>
                            <td>{{ trade.trade_date.strftime('%H:%M') }}</td>
                            <td>{{ trade.stock_code }}</td>
                            <td>{{ trade.stock_name or '-' }}</td>
                            <td>
                                <span class="badge badge-{{ 'success' if trade.trade_type == 'buy' else 'danger' }}">
                                    {{ 'ä¹°å…¥' if trade.trade_type == 'buy' else 'å–å‡º' }}
                                </span>
                            </td>
                            <td>{{ trade.quantity }}</td>
                            <td>Â¥{{ "%.2f"|format(trade.price) }}</td>
                            <td>Â¥{{ "%.2f"|format(trade.amount) }}</td>
                            <td class="thought-cell">{{ trade.thought or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <p>è¯¥æ—¥æœŸæš‚æ— äº¤æ˜“è®°å½•</p>
                </div>
            {% endif %}
        </div>

    {% elif report_type == 'monthly' %}
        <!-- æœˆæŠ¥è¡¨ -->
        <div class="report-summary">
            <h2>ğŸ“… {{ report_data.year }}å¹´{{ report_data.month }}æœˆ äº¤æ˜“æ±‡æ€»</h2>
            <div class="stats-grid stats-grid-2">
                <div class="stat-card">
                    <div class="stat-value">{{ report_data.total_trades }}</div>
                    <div class="stat-label">æ€»äº¤æ˜“ç¬”æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ report_data.daily_stats|length }}</div>
                    <div class="stat-label">äº¤æ˜“å¤©æ•°</div>
                </div>
            </div>
        </div>

        <div class="report-detail">
            <h3>ğŸ“‹ æ¯æ—¥äº¤æ˜“ç»Ÿè®¡</h3>
            {% if report_data.daily_stats %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>ä¹°å…¥ç¬”æ•°</th>
                            <th>å–å‡ºç¬”æ•°</th>
                            <th>ä¹°å…¥é‡‘é¢</th>
                            <th>å–å‡ºé‡‘é¢</th>
                            <th>å‡€é‡‘é¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for date, stats in report_data.daily_stats.items()|sort(reverse=true) %}
                        <tr>
                            <td>{{ date }}</td>
                            <td>{{ stats.buy }}</td>
                            <td>{{ stats.sell }}</td>
                            <td>Â¥{{ "%.2f"|format(stats.buy_amount) }}</td>
                            <td>Â¥{{ "%.2f"|format(stats.sell_amount) }}</td>
                            <td class="{{ 'positive' if stats.sell_amount - stats.buy_amount > 0 else 'negative' }}">
                                Â¥{{ "%.2f"|format(stats.sell_amount - stats.buy_amount) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <p>è¯¥æœˆä»½æš‚æ— äº¤æ˜“è®°å½•</p>
                </div>
            {% endif %}
        </div>

    {% else %}
        <!-- å¹´æŠ¥è¡¨ -->
        <div class="report-summary">
            <h2>ğŸ“… {{ report_data.year }}å¹´ äº¤æ˜“æ±‡æ€»</h2>
            <div class="stats-grid stats-grid-2">
                <div class="stat-card">
                    <div class="stat-value">{{ report_data.total_trades }}</div>
                    <div class="stat-label">æ€»äº¤æ˜“ç¬”æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ report_data.monthly_stats|length }}</div>
                    <div class="stat-label">äº¤æ˜“æœˆæ•°</div>
                </div>
            </div>
        </div>

        <div class="report-detail">
            <h3>ğŸ“‹ æ¯æœˆäº¤æ˜“ç»Ÿè®¡</h3>
            {% if report_data.monthly_stats %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æœˆä»½</th>
                            <th>ä¹°å…¥ç¬”æ•°</th>
                            <th>å–å‡ºç¬”æ•°</th>
                            <th>ä¹°å…¥é‡‘é¢</th>
                            <th>å–å‡ºé‡‘é¢</th>
                            <th>å‡€é‡‘é¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for month, stats in report_data.monthly_stats.items()|sort(reverse=true) %}
                        <tr>
                            <td>{{ month }}</td>
                            <td>{{ stats.buy }}</td>
                            <td>{{ stats.sell }}</td>
                            <td>Â¥{{ "%.2f"|format(stats.buy_amount) }}</td>
                            <td>Â¥{{ "%.2f"|format(stats.sell_amount) }}</td>
                            <td class="{{ 'positive' if stats.sell_amount - stats.buy_amount > 0 else 'negative' }}">
                                Â¥{{ "%.2f"|format(stats.sell_amount - stats.buy_amount) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <p>è¯¥å¹´ä»½æš‚æ— äº¤æ˜“è®°å½•</p>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}
