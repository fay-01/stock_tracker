{% extends "base.html" %}

{% block title %}äº¤æ˜“è®°å½• - è‚¡ç¥¨äº¤æ˜“è®°å½•ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ’¼ äº¤æ˜“è®°å½•ç®¡ç†</h1>
    <button class="btn btn-primary" onclick="document.getElementById('tradeModal').style.display='block'">
        + æ–°å¢äº¤æ˜“
    </button>
</div>

<!-- æ–°å¢äº¤æ˜“å¼¹çª— -->
<div id="tradeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“ æ·»åŠ äº¤æ˜“è®°å½•</h2>
            <button class="modal-close" onclick="document.getElementById('tradeModal').style.display='none'">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('trades') }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="stock_code">è‚¡ç¥¨ä»£ç  *</label>
                    <input type="text" id="stock_code" name="stock_code" required placeholder="å¦‚ï¼š600519">
                </div>
                <div class="form-group">
                    <label for="stock_name">è‚¡ç¥¨åç§°</label>
                    <input type="text" id="stock_name" name="stock_name" placeholder="å¦‚ï¼šè´µå·èŒ…å°">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="trade_type">äº¤æ˜“ç±»å‹ *</label>
                    <select id="trade_type" name="trade_type" required>
                        <option value="buy">ä¹°å…¥</option>
                        <option value="sell">å–å‡º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trade_date">äº¤æ˜“æ—¥æœŸ *</label>
                    <input type="date" id="trade_date" name="trade_date" required
                           value="{{ now().strftime('%Y-%m-%d') if now else '' }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="quantity">æ•°é‡ *</label>
                    <input type="number" id="quantity" name="quantity" required min="1" placeholder="è‚¡æ•°">
                </div>
                <div class="form-group">
                    <label for="price">ä»·æ ¼ *</label>
                    <input type="number" id="price" name="price" required min="0" step="0.01" placeholder="æ¯è‚¡ä»·æ ¼">
                </div>
            </div>

            <div class="form-group">
                <label for="thought">äº¤æ˜“æƒ³æ³•</label>
                <textarea id="thought" name="thought" rows="4"
                          placeholder="è®°å½•å½“æ—¶çš„äº¤æ˜“æ€è·¯å’Œæƒ³æ³•..."></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('tradeModal').style.display='none'">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- äº¤æ˜“è®°å½•åˆ—è¡¨ -->
<div class="table-container">
    {% if trades.items %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>è‚¡ç¥¨åç§°</th>
                        <th>ç±»å‹</th>
                        <th>æ•°é‡</th>
                        <th>ä»·æ ¼</th>
                        <th>é‡‘é¢</th>
                        <th>æƒ³æ³•</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades.items %}
                    <tr>
                        <td>{{ trade.trade_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ trade.stock_code }}</td>
                        <td>{{ trade.stock_name or '-' }}</td>
                        <td>
                            <span class="badge badge-{{ 'success' if trade.trade_type == 'buy' else 'danger' }}">
                                {{ 'ä¹°å…¥' if trade.trade_type == 'buy' else 'å–å‡º' }}
                            </span>
                        </td>
                        <td>{{ trade.quantity }}</td>
                        <td>Â¥{{ "%.2f"|format(trade.price) }}</td>
                        <td>Â¥{{ "%.2f"|format(trade.amount) }}</td>
                        <td class="thought-cell">
                            {% if trade.thought %}
                                <span class="thought-preview" title="{{ trade.thought }}">
                                    {{ trade.thought[:30] }}{% if trade.thought|length > 30 %}...{% endif %}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('delete_trade', id=trade.id) }}"
                               class="btn btn-sm btn-danger"
                               onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡äº¤æ˜“è®°å½•å—ï¼Ÿ')">åˆ é™¤</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        {% if trades.pages > 1 %}
            <div class="pagination">
                {% if trades.has_prev %}
                    <a href="{{ url_for('trades', page=trades.prev_num) }}" class="btn btn-sm">ä¸Šä¸€é¡µ</a>
                {% endif %}

                <span class="page-info">ç¬¬ {{ trades.page }} / {{ trades.pages }} é¡µ</span>

                {% if trades.has_next %}
                    <a href="{{ url_for('trades', page=trades.next_num) }}" class="btn btn-sm">ä¸‹ä¸€é¡µ</a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <p>æš‚æ— äº¤æ˜“è®°å½•</p>
            <button class="btn btn-primary" onclick="document.getElementById('tradeModal').style.display='block'">
                æ·»åŠ ç¬¬ä¸€ç¬”äº¤æ˜“
            </button>
        </div>
    {% endif %}
</div>

<script>
// è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('trade_date');
    if (!dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
});
</script>
{% endblock %}
