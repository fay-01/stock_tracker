{% extends "base.html" %}

{% block title %}æ¯æ—¥å¤ç›˜ - è‚¡ç¥¨äº¤æ˜“è®°å½•ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“ æ¯æ—¥å¤ç›˜</h1>
    <button class="btn btn-primary" onclick="document.getElementById('reflectionModal').style.display='block'">
        + æ–°å¢å¤ç›˜
    </button>
</div>

<!-- æ–°å¢å¤ç›˜å¼¹çª— -->
<div id="reflectionModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>ğŸ“ æ·»åŠ å¤ç›˜è®°å½•</h2>
            <button class="modal-close" onclick="document.getElementById('reflectionModal').style.display='none'">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('reflections') }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="reflection_date">å¤ç›˜æ—¥æœŸ *</label>
                    <input type="date" id="reflection_date" name="reflection_date" required>
                </div>
                <div class="form-group">
                    <label for="profit_loss">å½“æ—¥ç›ˆäº</label>
                    <input type="number" id="profit_loss" name="profit_loss" step="0.01"
                           placeholder="æ­£æ•°è¡¨ç¤ºç›ˆåˆ©ï¼Œè´Ÿæ•°è¡¨ç¤ºäºæŸ">
                </div>
            </div>

            <div class="form-group">
                <label for="content">å¤ç›˜å†…å®¹ *</label>
                <textarea id="content" name="content" rows="8" required
                          placeholder="è®°å½•ä»Šå¤©çš„æŠ•èµ„å¿ƒå¾—ã€å¸‚åœºåˆ†æã€æ“ä½œåæ€..."></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('reflectionModal').style.display='none'">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¤ç›˜è®°å½•åˆ—è¡¨ -->
<div class="reflections-grid">
    {% if reflections.items %}
        {% for reflection in reflections.items %}
        <div class="reflection-card-full">
            <div class="reflection-card-header">
                <div class="reflection-date-group">
                    <span class="reflection-date">{{ reflection.reflection_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</span>
                    <span class="reflection-weekday">{{ reflection.reflection_date.strftime('%A') }}</span>
                </div>
                {% if reflection.profit_loss is not none %}
                    <span class="reflection-pl-badge {{ 'positive' if reflection.profit_loss > 0 else 'negative' }}">
                        {{ '+' if reflection.profit_loss > 0 else '' }}Â¥{{ "%.2f"|format(reflection.profit_loss) }}
                    </span>
                {% endif %}
                <div class="reflection-actions">
                    <a href="{{ url_for('delete_reflection', id=reflection.id) }}"
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡å¤ç›˜å—ï¼Ÿ')">åˆ é™¤</a>
                </div>
            </div>
            <div class="reflection-card-body">
                {{ reflection.content|replace('\n', '<br>')|safe }}
            </div>
        </div>
        {% endfor %}

        <!-- åˆ†é¡µ -->
        {% if reflections.pages > 1 %}
            <div class="pagination">
                {% if reflections.has_prev %}
                    <a href="{{ url_for('reflections', page=reflections.prev_num) }}" class="btn btn-sm">ä¸Šä¸€é¡µ</a>
                {% endif %}

                <span class="page-info">ç¬¬ {{ reflections.page }} / {{ reflections.pages }} é¡µ</span>

                {% if reflections.has_next %}
                    <a href="{{ url_for('reflections', page=reflections.next_num) }}" class="btn btn-sm">ä¸‹ä¸€é¡µ</a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <p>æš‚æ— å¤ç›˜è®°å½•</p>
            <button class="btn btn-primary" onclick="document.getElementById('reflectionModal').style.display='block'">
                æ·»åŠ ç¬¬ä¸€ç¯‡å¤ç›˜
            </button>
        </div>
    {% endif %}
</div>

<script>
// è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('reflection_date');
    if (!dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
});
</script>
{% endblock %}
